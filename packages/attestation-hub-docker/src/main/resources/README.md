ISecL v1 Server containers
==========================
This repo is to create an image for ISL v1 Attestation Hub container. 
Below instructions help in building and running the Attestation Hub 
contianer on Docker runtime.

Pre-requisites
----------------------

* Install Docker runtime: yum install -y docker
* Start docker service: systemctl start docker
* Install docker-compose: 
    sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose

    More info: https://docs.docker.com/compose/install/#install-compose

Building the containers
-----------------------

ISecL sever components could be built using docker-compose or vanilla docker commands. 
This section explains building the images using docker-compose

* **Directory structure**
    ISL v1 Attestation Hub ontainer can be built using docker-compose. 
    For building the containers, below files and directories are expected 
    in the build(current) directory where the docker-compse.yml is exists.

    .
    +-- docker\_compose.yml 
    |
    +-- attestation-hub.env
    |
    +-- Dockerfile: Invoked by docker-compose to buid the image
    |
    +-- attestation-cache-hub-linux-4.0.bin: Installer
    |
    +-- start_ahub: Entrypscript
    |
    +-- db.password: postgres DB password (default: Ch@ng3_m3. Change it before running the container)
    |
    +-- attestation-hub.env: Env file with the Verification service details. Need to be updated before running the container
    |
    +-- yum.repos.d/: To leverage custom RHEL repos


* **Container Environment**
    ISecL v1 Containers are built over RHEL 7.4 base image. When creating the container
    image, the installers are run such that the static content is extracted  
    and placed in the right locations (ex: /opt/attestation-hub).

    All setup and provisioning tasks are performed during the image launch

* **Docker build command**

    *Simple Container image build*
    docker-compose build -t attestation-hub

    *Container build behind proxy with custom RHEL repos*

    docker-compose build --build-arg http_proxy=<http_proxy_server> \
        --build-arg https_proxy=<https_proxy_server> \
        --build-arg no_proxy=<repo_and_other_local_servers> \
        attestation-hub

Running the container
---------------------

* **Create volumes**
    All the configuration, logs and non-static content generated by the agent
    is stored as part of the volumes so that the agent container remains 
    stateless. So, the below volumes needs to be created before launching the
    agent container.

    Refer [Docker Volumes](https://docs.docker.com/storage/volumes/) for volume 
    management on Docker


    * **Attestation Hub volumes** *

    | Type          | Name                      | Container Path                     |
    |:-------------:|:-------------------------:|:----------------------------------:|
    | Volume        | ahub_config-volume        | /opt/attestation-hub/configuration |
    | Volume        | ahub-logs-volume          | /opt/attestation-hub/logs          |
    | Volume        | ahub-tenant-config-volume | /opt/tenantconfig                  |

    Volumes would be automatically created by docker-compose. 

    Below are the commands to create the required "Volumes" if native docker 
    commands are used to run the image

    > # Create volume for tagent_logs
    > docker volume create --label ahub-config-volume


* **Running ISecLv1 Attestation Hub image**

    Running the ISecL v1 Attestation Hub container, below env file is needed 
    with the verification server details

    * attestation-hub.env
        Contains the Admin Username and password. If provided this user is created on attestation-hub

        MTWILSON_IP_ADDRESS=<Verification Service IP>
        MTWILSON_HOSTNAME=<ISecL Server Hostname or IP Address if the service is running on a host.>
                          # If running on a container, name it "verification-service"
        MTWILSON_USERNAME=<Verification Service User>
        MTWILSON_PASSWORD=<Verification Service Password>
        MTWILSON_TLS_CERT_SHA384=<Verification Service TLS SHA384>

        AHUB_USER_NAME=<Username>
        AHUB_USER_PASSWORD=<Password>

     A helper script (get_tls_sha384) is provided along with the package. This script
     would retrieve the tls sha384 from the server. Please source the above env file
     before invoking the helper script.


    * db.password

         Update the file to set the Postgres password

    * **Command to run ISecL v1 agent** *
    docker-compose up --remove-orphans --abort-on-container-exit

    `docker ps` should show the Attestation Hub and postgres containers as below
        attestation-hub_attestation-hub_1
        attestation-hub_ahub-pg-db_1


* **Restarting the Container**

    Once the container is down/stopped (docker-compose down), the containers does not need the env files and
    db.password to restart since the setup activities are done during the first launch and the configurations
    are stoed as part of the volumes. 

    Two options to run the containers without the configuration

        1. Comment out all the "secrets" block in docker-compose.yml

        2. Delete all the contents in the env and db.password files.

    After the above, run docker-compose up --remove-orphans to start the containers again
